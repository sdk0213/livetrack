<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunCheer TEST - 성대경 #1080</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🧪</text></svg>" />
  <style>
    :root{--bg:#f5f7fa;--card:#ffffff;--muted:#64748b;--fg:#1e293b;--acc:#3b82f6;--ok:#22c55e;--err:#ef4444;--finished:#dbeafe}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif;scroll-behavior:auto}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    h1{margin:0 0 6px;font-size:20px}
    .muted{color:var(--muted)}
    .card{background:var(--card);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 240px}
    input,textarea,button{width:100%;box-sizing:border-box;background:#f8fafc;border:1px solid #cbd5e1;color:var(--fg);border-radius:10px;padding:10px}
    button{cursor:pointer;background:linear-gradient(180deg,#3b82f6,#2563eb);border:none;color:#fff}
    button.secondary{background:#f8fafc;border:1px solid #cbd5e1;color:var(--fg)}
    button:disabled{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:12px;table-layout:fixed}
    th,td{text-align:left;padding:10px 12px;vertical-align:top;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    th{font-size:11px;line-height:1.3;white-space:normal}
    tbody tr{background:#f8fafc}
    tbody tr.finished{background:var(--finished)!important}
    tbody tr.player-main td:first-child{border-radius:10px 0 0 0;white-space:normal}
    tbody tr.player-main td:last-child{border-radius:0 10px 0 0}
    tbody tr.player-splits td{border-top:1px solid #e2e8f0;border-radius:0 0 10px 10px;padding-top:8px;white-space:normal}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .tiny{font-size:12px}
    .err{color:var(--err)}
    .splits{display:flex;flex-direction:column;gap:3px;font-size:12px;color:var(--muted);padding:5px 0}
    #map{width:100%;height:500px;border-radius:10px;background:#e2e8f0}
    .loading{display:inline-block;width:14px;height:14px;border:2px solid #cbd5e1;border-top-color:var(--acc);border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .player-count{font-size:13px;color:var(--muted);margin-top:8px;font-weight:600}
    .test-badge{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;display:inline-block;margin-left:8px}
    .refresh-indicator{
      position:fixed;
      bottom:20px;
      right:20px;
      background:rgba(66,133,244,0.75);
      color:#fff;
      padding:8px 14px;
      border-radius:20px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      font-size:11px;
      font-weight:600;
      display:none;
      align-items:center;
      gap:8px;
      z-index:1000;
    }
    .refresh-indicator.active{
      display:flex;
    }
    .refresh-progress{
      width:28px;
      height:28px;
      position:relative;
    }
    .refresh-progress svg{
      transform:rotate(-90deg);
    }
    .refresh-progress-circle{
      fill:none;
      stroke:rgba(255,255,255,0.3);
      stroke-width:3;
    }
    .refresh-progress-bar{
      fill:none;
      stroke:#fff;
      stroke-width:3;
      stroke-linecap:round;
      transition:stroke-dashoffset 1s linear;
    }
    .player-label{
      background:rgba(59,130,246,0.95);
      color:#fff;
      padding:6px 12px;
      border-radius:20px;
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
      border:2px solid #fff;
      cursor:pointer;
      transition:all 0.2s;
    }
    .player-label:hover{
      background:rgba(37,99,235,1);
      transform:scale(1.05);
    }
  </style>
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=04ebpnqto6"></script>
</head>
<body>
  <div id="refreshIndicator" class="refresh-indicator">
    <div class="refresh-progress">
      <svg width="28" height="28">
        <circle class="refresh-progress-circle" cx="14" cy="14" r="11"></circle>
        <circle id="progressBar" class="refresh-progress-bar" cx="14" cy="14" r="11"></circle>
      </svg>
    </div>
    <div>
      <div style="font-size:9px;opacity:0.9">새로고침</div>
      <div id="countdown" style="font-size:12px;font-weight:700">60초</div>
    </div>
  </div>
  <div class="wrap">
    <h1>RunCheer <span class="test-badge">🧪 TEST MODE</span><br><span style="font-size:14px;font-weight:normal;color:var(--muted)">(테스트 페이지 - 성대경 #1080)</span></h1>
    
    <div class="card">
      <div class="row">
        <div class="col">
          <label class="tiny muted">테스트 주자</label>
          <div class="mono">성대경 (#1080) - 런티풀</div>
        </div>
        <div class="col">
          <label class="tiny muted">출발 시간</label>
          <div class="mono">오후 3시 (15:00)</div>
        </div>
        <div class="col" style="flex:0 0 220px;align-self:end;display:flex;gap:8px">
          <button id="startBtn">추적 시작</button>
          <button id="stopBtn" class="secondary" disabled>추적 정지</button>
        </div>
      </div>
    </div>

    <!-- 지도 -->
    <div class="card">
      <div style="font-weight:700;margin-bottom:10px">📍 주자 위치 (예상 위치 표시 Beta)</div>
      <div style="color:var(--err);font-size:12px;margin-bottom:10px;font-weight:600">⚠️ 동작하지 않을 수 있습니다. 미동작 시 아래 테이블에서 마지막 위치를 직접 확인해주세요.</div>
      <div id="map"></div>
    </div>

    <!-- 결과 테이블 -->
    <div class="card">
      <div id="status" class="tiny muted">추적 시작 버튼을 누르세요.</div>
      <table>
        <thead>
          <tr><th>이름<br>(배번)<br>(그룹)</th><th>상태</th><th>달린<br>거리</th><th>마지막<br>위치</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
function API(path){return `/api/test-api?path=${encodeURIComponent(path)}`;}
const $=s=>document.querySelector(s);
function fmtClockISO(i){return i?i.replace('T',' ').replace('Z',''):''}
const S={timer:null,mapTimer:null,countdownTimer:null,rows:new Map(),map:null,markers:new Map(),gpxPoints:[],checkpointMarkers:[],remainingSeconds:60};

function calcDistance(lat1,lng1,lat2,lng2){const R=6371;const dLat=(lat2-lat1)*Math.PI/180;const dLng=(lng2-lng1)*Math.PI/180;const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c;}

function getPositionOnRoute(distanceKm){if(!S.gpxPoints||S.gpxPoints.length===0)return null;let accumulated=0;for(let i=1;i<S.gpxPoints.length;i++){const prev=S.gpxPoints[i-1];const curr=S.gpxPoints[i];const segDist=calcDistance(prev.lat(),prev.lng(),curr.lat(),curr.lng());if(accumulated+segDist>=distanceKm){const ratio=(distanceKm-accumulated)/segDist;const lat=prev.lat()+(curr.lat()-prev.lat())*ratio;const lng=prev.lng()+(curr.lng()-prev.lng())*ratio;return new naver.maps.LatLng(lat,lng);}accumulated+=segDist;}return S.gpxPoints[S.gpxPoints.length-1];}

async function loadGPXCourse(){
  try{
    const r=await fetch('/course-jtbc2025.gpx');
    const text=await r.text();
    const parser=new DOMParser();
    const xml=parser.parseFromString(text,'text/xml');
    const trkpts=xml.querySelectorAll('trkpt');
    const path=[];
    trkpts.forEach(pt=>{
      const lat=parseFloat(pt.getAttribute('lat'));
      const lon=parseFloat(pt.getAttribute('lon'));
      if(lat&&lon)path.push(new naver.maps.LatLng(lat,lon));
    });
    S.gpxPoints=path;
    console.log(`GPX loaded: ${path.length} points`);
    return path;
  }catch(e){
    console.error('Failed to load GPX:',e);
    return null;
  }
}

async function drawCoursePath(){
  if(!S.map)return;
  const path=await loadGPXCourse();
  if(!path)return;
  
  if(S.coursePath)S.coursePath.setMap(null);
  S.coursePath=new naver.maps.Polyline({
    map:S.map,
    path:path,
    strokeColor:'#4285f4',
    strokeOpacity:0.6,
    strokeWeight:4
  });
  
  const checkpoints=[
    {name:'출발',distance:0.00},
    {name:'5K',distance:5.00},
    {name:'10K',distance:10.00},
    {name:'15K',distance:15.00},
    {name:'20K',distance:20.00},
    {name:'Half',distance:21.10},
    {name:'25K',distance:25.00},
    {name:'30K',distance:30.00},
    {name:'35K',distance:35.00},
    {name:'40K',distance:40.00},
    {name:'도착',distance:42.195}
  ];
  
  S.checkpointMarkers.forEach(m=>m.setMap(null));
  S.checkpointMarkers=[];
  
  checkpoints.forEach(cp=>{
    const pos=getPositionOnRoute(cp.distance);
    if(pos){
      const marker=new naver.maps.Marker({
        position:pos,
        map:S.map,
        icon:{
          content:`<div style="background:#2a3f5f;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:bold;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);">${cp.name}</div>`,
          anchor:new naver.maps.Point(0,25)
        }
      });
      S.checkpointMarkers.push(marker);
    }
  });
}

async function fetchPlayer(){
  const r=await fetch(API('test/1080'));
  if(!r.ok)throw new Error('HTTP '+r.status);
  return await r.json();
}

function estimateNow(j){
  const dist=parseFloat(j.course?.distance||'0');
  const recs=(j.records||[]).sort((a,b)=>a.point.distance-b.point.distance);
  if(!recs.length)return{status:'대기',d:0,name:'',iso:'',estimated:0};
  const lastRec=recs.at(-1);
  const d=parseFloat(lastRec.point.distance);
  const name=lastRec.point.name;
  const time=lastRec.time_point;
  const date=j.event?.date;
  const lastTime=new Date(`${date}T${time}`);
  const now=new Date();
  const elapsedSec=(now-lastTime)/1000;
  let estimatedDist=d;
  if(elapsedSec>0&&!j.result_nettime){
    let paceSec=360;
    if(j.pace_nettime){
      const paceStr=j.pace_nettime.split('.')[0];
      paceSec=timeToSeconds(paceStr);
    }
    if(paceSec>0){
      const kmPerSec=1/paceSec;
      const movedKm=kmPerSec*elapsedSec;
      estimatedDist=Math.min(d+movedKm,dist);
    }
  }
  return{status:j.result_nettime?'완주':'주행',d,name,iso:lastTime.toISOString(),estimated:estimatedDist};
}

function cleanTime(t){if(!t)return'';return t.split('.')[0]}
function timeToSeconds(t){if(!t)return 0;const clean=t.split('.')[0];const p=clean.split(':').map(Number);if(p.length===3)return p[0]*3600+p[1]*60+p[2];if(p.length===2)return p[0]*60+p[1];return 0}
function calcPace(distKm,sec){if(!distKm||distKm<=0)return'';const minPerKm=sec/60/distKm;const m=Math.floor(minPerKm);const s=Math.round((minPerKm-m)*60);return`${m}'${s.toString().padStart(2,'0')}"`}

function renderSplits(j){
  const recs=(j.records||[]).sort((a,b)=>a.point.distance-b.point.distance);
  const netTime=cleanTime(j.result_nettime);
  const pace=cleanTime(j.pace_nettime);
  const netPaceStr=netTime&&pace?`${netTime} (${pace})`:netTime||pace||'';
  let splitsHTML=recs.map((r,i)=>{
    let pace='';
    if(i>0){
      const prevDist=recs[i-1].point.distance;
      const dist=r.point.distance-prevDist;
      const prevSec=timeToSeconds(recs[i-1].time_point);
      const sec=timeToSeconds(r.time_point)-prevSec;
      pace=` (${calcPace(dist,sec)})`;
    }
    return`<div>${r.point.name||''} ${r.point.distance}km ${cleanTime(r.time_point)}${pace}</div>`;
  }).join('');
  if(netPaceStr){
    splitsHTML+=`<div style="margin-top:8px;font-weight:700;color:#4285f4">최종기록: ${netPaceStr}</div>`;
  }
  return`<div class='splits'>${splitsHTML}</div>`;
}

function ensureRow(bib){
  if(S.rows.has(bib))return S.rows.get(bib);
  const trMain=document.createElement('tr');
  trMain.className='player-main';
  trMain.innerHTML='<td></td><td></td><td></td><td></td>';
  const trSplits=document.createElement('tr');
  trSplits.className='player-splits';
  trSplits.innerHTML='<td colspan="4" style="padding:8px 12px"></td>';
  $('#tbody').appendChild(trMain);
  $('#tbody').appendChild(trSplits);
  const c=trMain.querySelectorAll('td');
  const splitsCell=trSplits.querySelector('td');
  S.rows.set(bib,{trMain,trSplits,c,splitsCell,data:null});
  return S.rows.get(bib);
}

function updateRow(j){
  const bib=j.num||j.tag;
  const r=ensureRow(bib);
  r.data=j;
  const est=estimateNow(j);
  const teamName=j.team_name?`<br>(${j.team_name})`:'';
  r.c[0].innerHTML=`${j.name}<br>(#${bib})${teamName}`;
  r.c[1].textContent=est.status;
  r.c[2].textContent=est.d;
  r.c[3].textContent=est.name;
  r.splitsCell.innerHTML=renderSplits(j);
  r.trMain.classList.toggle('finished',est.estimated>=42);
}

function initMap(){
  if(!window.naver||!window.naver.maps){
    console.error('Naver Maps API not loaded');
    return;
  }
  const center=new naver.maps.LatLng(37.5665,126.9780);
  S.map=new naver.maps.Map('map',{center:center,zoom:13,mapTypeControl:true});
  drawCoursePath();
  console.log('Map initialized');
}

function updateMarker(playerData,bib){
  if(!S.map)return;
  const est=estimateNow(playerData);
  const distKm=parseFloat(est.estimated);
  if(!distKm||distKm===0)return;
  const pos=getPositionOnRoute(distKm);
  if(!pos)return;
  
  if(S.markers.has(bib)){
    const item=S.markers.get(bib);
    item.marker.setPosition(pos);
    item.label.setPosition(pos);
  }else{
    const marker=new naver.maps.Marker({
      position:pos,
      map:S.map,
      icon:{
        content:`<div style="width:12px;height:12px;background:#5cc8ff;border:3px solid #fff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>`,
        anchor:new naver.maps.Point(9,9)
      }
    });
    const labelContent=`<div class="player-label">${playerData.name}</div>`;
    const label=new naver.maps.Marker({
      position:pos,
      map:S.map,
      icon:{
        content:labelContent,
        anchor:new naver.maps.Point(0,30)
      }
    });
    S.markers.set(bib,{marker:marker,label:label});
    S.map.setCenter(pos);
    S.map.setZoom(14);
  }
}

function updateCountdown(){
  const circumference=2*Math.PI*11;
  const progressBar=$('#progressBar');
  progressBar.style.strokeDasharray=circumference;
  
  S.remainingSeconds--;
  if(S.remainingSeconds<0)S.remainingSeconds=60;
  
  const offset=circumference*(1-S.remainingSeconds/60);
  progressBar.style.strokeDashoffset=offset;
  $('#countdown').textContent=`${S.remainingSeconds}초`;
}

function startCountdown(){
  S.remainingSeconds=60;
  $('#refreshIndicator').classList.add('active');
  updateCountdown();
  S.countdownTimer=setInterval(updateCountdown,1000);
}

function stopCountdown(){
  if(S.countdownTimer){
    clearInterval(S.countdownTimer);
    S.countdownTimer=null;
  }
  $('#refreshIndicator').classList.remove('active');
}

async function tick(){
  S.remainingSeconds=60;
  updateCountdown();
  const statusEl=$('#status');
  statusEl.innerHTML='새로고침 중... <span class="loading"></span>';
  
  try{
    const j=await fetchPlayer();
    updateRow(j);
    updateMarker(j,'1080');
    statusEl.textContent=`마지막 업데이트: ${new Date().toLocaleTimeString('ko-KR')}`;
  }catch(e){
    statusEl.innerHTML=`<span class="err">⚠️ 에러: ${String(e)}</span>`;
  }
}

$('#startBtn').onclick=async()=>{
  $('#startBtn').disabled=true;
  $('#stopBtn').disabled=false;
  tick();
  startCountdown();
  S.timer=setInterval(tick,60000);
  S.mapTimer=setInterval(()=>{
    const r=S.rows.get('1080');
    if(r&&r.data)updateMarker(r.data,'1080');
  },15000);
};

$('#stopBtn').onclick=()=>{
  clearInterval(S.timer);
  clearInterval(S.mapTimer);
  stopCountdown();
  S.timer=null;
  S.mapTimer=null;
  $('#startBtn').disabled=false;
  $('#stopBtn').disabled=true;
};

setTimeout(initMap,500);
</script>
</body>
</html>
