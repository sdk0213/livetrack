<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>예상 위치 계산 테스트 - 춘천마라톤</title>
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; background: #0e111a; color: #e0e6ed; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1 { color: #5cc8ff; }
    .controls { background: #1a1f2e; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    label { display: block; margin: 10px 0 5px 0; font-weight: bold; color: #5cc8ff; }
    input, select { width: 100%; padding: 8px; border: 1px solid #2a3f5f; border-radius: 5px; background: #0e111a; color: #e0e6ed; box-sizing: border-box; }
    button { background: #5cc8ff; color: #0e111a; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; }
    button:hover { background: #1a9fff; }
    #map { width: 100%; height: 500px; border-radius: 10px; margin-bottom: 20px; }
    .info-panel { background: #1a1f2e; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    .player-info { background: #0e111a; padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #5cc8ff; }
    .estimated { color: #ff9800; }
    .actual { color: #4285f4; }
  </style>
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=04ebpnqto6"></script>
</head>
<body>
  <div class="container">
    <h1>📍 춘천마라톤 예상 위치 테스트</h1>
    
    <div class="controls">
      <label>현재 시간 (테스트용)</label>
      <input type="datetime-local" id="currentTime" value="2025-10-26T10:30:00">
      
      <label>배번</label>
      <input type="number" id="bib" value="1003">
      
      <button onclick="updateTest()">위치 업데이트</button>
      <button onclick="addMinutes(5)">+5분</button>
      <button onclick="addMinutes(10)">+10분</button>
      <button onclick="addMinutes(30)">+30분</button>
    </div>
    
    <div id="info" class="info-panel"></div>
    
    <div id="map"></div>
  </div>

  <script>
    let map = null;
    let marker = null;
    let label = null;
    let coursePath = null;
    let gpxPoints = [];
    
    // 가짜 주자 데이터 (춘천마라톤 132번)
    const fakePlayerData = {
      "event_id": 132,
      "num": "1003",
      "name": "테스트 주자",
      "result_nettime": null,
      "pace_nettime": "05:48",
      "event": {
        "id": 132,
        "name": "2025 춘천마라톤",
        "date": "2025-10-26"
      },
      "course": {
        "distance": "42.195"
      },
      "records": [
        {
          "point": { "name": "출발", "distance": "0.00" },
          "time_point": "09:06:20"
        },
        {
          "point": { "name": "반환점", "distance": "4.00" },
          "time_point": "09:27:14"
        },
        {
          "point": { "name": "5K", "distance": "5.00" },
          "time_point": "09:33:29"
        },
        {
          "point": { "name": "10K", "distance": "10.00" },
          "time_point": "10:01:21"
        }
      ]
    };
    
    function timeToSeconds(t) {
      if (!t) return 0;
      const clean = t.split('.')[0];
      const p = clean.split(':').map(Number);
      if (p.length === 3) return p[0] * 3600 + p[1] * 60 + p[2];
      if (p.length === 2) return p[0] * 60 + p[1];
      return 0;
    }
    
    function calcDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
    
    function getPositionOnRoute(distanceKm) {
      if (!gpxPoints || gpxPoints.length === 0) return null;
      let accumulated = 0;
      for (let i = 1; i < gpxPoints.length; i++) {
        const prev = gpxPoints[i - 1];
        const curr = gpxPoints[i];
        const segDist = calcDistance(prev.lat(), prev.lng(), curr.lat(), curr.lng());
        if (accumulated + segDist >= distanceKm) {
          const ratio = (distanceKm - accumulated) / segDist;
          const lat = prev.lat() + (curr.lat() - prev.lat()) * ratio;
          const lng = prev.lng() + (curr.lng() - prev.lng()) * ratio;
          return new naver.maps.LatLng(lat, lng);
        }
        accumulated += segDist;
      }
      return gpxPoints[gpxPoints.length - 1];
    }
    
    function estimateNow(playerData, currentTime) {
      const dist = parseFloat(playerData.course?.distance || '0');
      const recs = (playerData.records || []).sort((a, b) => a.point.distance - b.point.distance);
      if (!recs.length) return { status: '대기', d: 0, name: '', estimated: 0 };
      
      const lastRec = recs[recs.length - 1];
      const d = parseFloat(lastRec.point.distance);
      const name = lastRec.point.name;
      const time = lastRec.time_point;
      const date = playerData.event?.date;
      
      const lastTime = new Date(`${date}T${time}`);
      const now = new Date(currentTime);
      const elapsedSec = (now - lastTime) / 1000;
      
      let estimatedDist = d;
      if (playerData.pace_nettime && elapsedSec > 0 && !playerData.result_nettime) {
        const paceStr = playerData.pace_nettime.split('.')[0];
        const paceSec = timeToSeconds(paceStr);
        if (paceSec > 0) {
          const kmPerSec = 1 / (paceSec / 60);
          const movedKm = kmPerSec * elapsedSec;
          estimatedDist = Math.min(d + movedKm, dist);
        }
      }
      
      return {
        status: playerData.result_nettime ? '완주' : '주행',
        d,
        name,
        estimated: estimatedDist,
        elapsedSec,
        lastTime
      };
    }
    
    async function loadGPX() {
      try {
        const r = await fetch('/course.gpx');
        const text = await r.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, 'text/xml');
        const trkpts = xml.querySelectorAll('trkpt');
        const path = [];
        trkpts.forEach(pt => {
          const lat = parseFloat(pt.getAttribute('lat'));
          const lon = parseFloat(pt.getAttribute('lon'));
          if (lat && lon) path.push(new naver.maps.LatLng(lat, lon));
        });
        gpxPoints = path;
        
        // 코스 경로 그리기
        coursePath = new naver.maps.Polyline({
          path: path,
          strokeColor: '#FF0000',
          strokeOpacity: 0.6,
          strokeWeight: 4,
          map: map
        });
        
        const bounds = new naver.maps.LatLngBounds();
        path.forEach(p => bounds.extend(p));
        map.fitBounds(bounds);
      } catch (e) {
        console.error('Failed to load GPX:', e);
      }
    }
    
    function updateTest() {
      const currentTime = document.getElementById('currentTime').value;
      const bib = document.getElementById('bib').value;
      
      const est = estimateNow(fakePlayerData, currentTime);
      const pos = getPositionOnRoute(est.estimated);
      
      if (!pos) {
        alert('GPX 로딩 중입니다. 잠시 후 다시 시도해주세요.');
        return;
      }
      
      const isEstimated = est.estimated > est.d;
      
      // 마커 업데이트
      if (marker) {
        marker.setPosition(pos);
        label.setPosition(pos);
        const newContent = `<div style="
          background: ${isEstimated ? 'rgba(255,152,0,0.95)' : 'rgba(66,133,244,0.95)'};
          color: white;
          padding: 6px 12px;
          border-radius: 16px;
          font-weight: bold;
          font-size: 13px;
          white-space: nowrap;
          box-shadow: 0 2px 6px rgba(0,0,0,0.3);
          border: 2px solid white;
        ">${fakePlayerData.name}${isEstimated ? ' 📍' : ''}</div>`;
        label.setIcon({ content: newContent, anchor: new naver.maps.Point(0, 30) });
      } else {
        marker = new naver.maps.Marker({
          position: pos,
          map: map,
          icon: {
            content: `<div style="width:12px;height:12px;background:#5cc8ff;border:3px solid #fff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>`,
            anchor: new naver.maps.Point(9, 9)
          }
        });
        
        const labelContent = `<div style="
          background: ${isEstimated ? 'rgba(255,152,0,0.95)' : 'rgba(66,133,244,0.95)'};
          color: white;
          padding: 6px 12px;
          border-radius: 16px;
          font-weight: bold;
          font-size: 13px;
          white-space: nowrap;
          box-shadow: 0 2px 6px rgba(0,0,0,0.3);
          border: 2px solid white;
        ">${fakePlayerData.name}${isEstimated ? ' 📍' : ''}</div>`;
        
        label = new naver.maps.Marker({
          position: pos,
          map: map,
          icon: { content: labelContent, anchor: new naver.maps.Point(0, 30) }
        });
      }
      
      map.setCenter(pos);
      map.setZoom(14);
      
      // 정보 패널 업데이트
      const info = document.getElementById('info');
      info.innerHTML = `
        <div class="player-info">
          <h3>${fakePlayerData.name} (#${bib})</h3>
          <p><strong>마지막 통과:</strong> ${est.name} (${est.d}km) - ${est.lastTime.toLocaleTimeString()}</p>
          <p><strong>현재 시간:</strong> ${new Date(currentTime).toLocaleTimeString()}</p>
          <p><strong>경과 시간:</strong> ${Math.floor(est.elapsedSec / 60)}분 ${Math.floor(est.elapsedSec % 60)}초</p>
          <p><strong>페이스:</strong> ${fakePlayerData.pace_nettime}/km</p>
          ${isEstimated ? 
            `<p class="estimated"><strong>📍 예상 위치:</strong> ${est.estimated.toFixed(2)}km (추가 이동: ${(est.estimated - est.d).toFixed(2)}km)</p>` :
            `<p class="actual"><strong>현재 위치:</strong> ${est.d}km</p>`
          }
        </div>
      `;
    }
    
    function addMinutes(min) {
      const input = document.getElementById('currentTime');
      const current = new Date(input.value);
      current.setMinutes(current.getMinutes() + min);
      input.value = current.toISOString().slice(0, 16);
      updateTest();
    }
    
    // 초기화
    window.onload = async () => {
      map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(37.878, 127.73),
        zoom: 13
      });
      
      await loadGPX();
      updateTest();
    };
  </script>
</body>
</html>
