<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyResult 러너 현황(추정) — 단일 HTML</title>
  <style>
    :root { --bg:#0b0c10; --card:#151821; --fg:#e8eef9; --muted:#9fb0c7; --accent:#5cc8ff; --ok:#7CFC00; --warn:#ffcc00; --err:#ff6b6b; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 12px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.25);padding:16px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>.col{flex:1 1 220px}
    label{display:block;font-weight:600;margin:0 0 6px;color:var(--muted)}
    input,textarea,select,button{width:100%;box-sizing:border-box;background:#0e111a;border:1px solid #2a3142;color:var(--fg);border-radius:10px;padding:10px}
    button{cursor:pointer;background:linear-gradient(180deg,#1a9fff,#0066cc);border:none}
    button.secondary{background:#0e111a;border:1px solid #2a3142}
    button:disabled{opacity:.5;cursor:not-allowed}
    .grid{width:100%;overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:10px 12px}
    thead th{position:sticky;top:0;background:var(--bg);z-index:1}
    tbody tr{background:#0e111a}
    tbody tr td:first-child{border-radius:10px 0 0 10px}
    tbody tr td:last-child{border-radius:0 10px 10px 0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .pill.ok{background:rgba(124,252,0,.12);color:var(--ok)}
    .pill.run{background:rgba(92,200,255,.12);color:var(--accent)}
    .pill.fin{background:rgba(159,176,199,.12);color:#d7e1f3}
    .muted{color:var(--muted)}
    .tiny{font-size:12px}
    .right{text-align:right}
    .progress{height:8px;background:#1b2230;border-radius:6px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#00eaff,#5cc8ff)}
    .foot{color:var(--muted);font-size:12px;margin-top:8px}
    .err{color:var(--err)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>MyResult 러너 현황(추정) — 서버 없이 단일 HTML</h1>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>이벤트 ID</label>
          <input id="eventId" value="110" />
        </div>
        <div class="col">
          <label>조회 주기(초)</label>
          <input id="intervalSec" type="number" min="5" value="10" />
        </div>
        <div class="col" style="flex:0 0 160px;align-self:end;display:flex;gap:8px">
          <button id="startBtn">시작</button>
          <button id="stopBtn" class="secondary" disabled>정지</button>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>배번(쉼표/줄바꿈 구분, 약 30명)</label>
          <textarea id="bibs" rows="4" placeholder="예: 3725,3729,3730\n또는 줄바꿈으로 여러 개"></textarea>
          <div class="foot">⚠️ 개인정보 주의: 서버 저장 없음. 브라우저 메모리에서만 처리. 전화번호 등 민감 정보는 표시/저장하지 않음.</div>
          <div class="foot">ⓘ CORS로 차단될 경우, 이 HTML을 파일로 더블클릭(file://)이 아닌 <span class="mono">python -m http.server</span> 또는 GitHub Pages 등에서 열어보세요.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <table id="tbl">
          <thead>
            <tr>
              <th>이름</th>
              <th>배번</th>
              <th>상태</th>
              <th>누적(km)</th>
              <th>마지막 통과</th>
              <th>통과시각</th>
              <th>넷기록</th>
              <th>페이스(평균)</th>
              <th>진행률</th>
              <th class="right">오류</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="foot tiny">추정 로직: 마지막 체크포인트 이후 구간은 직전 구간 페이스(없으면 평균 페이스)로 선형 보간. 실제 GPS 실시간은 아님.</div>
  </div>

  <script>
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  const state = {
    timer: null,
    cache: new Map(), // key: bib -> last json
  };

  function parseBibs(text){
    return text.split(/[\n,\s]+/).map(s=>s.trim()).filter(Boolean);
  }

  function fmtTime(ts){
    if(!ts) return '';
    return ts.replace('T',' ').replace('Z','');
  }
  function fmtSec(sec){
    sec = Math.max(0, Math.round(sec));
    const h = Math.floor(sec/3600); sec%=3600;
    const m = Math.floor(sec/60); const s = sec%60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  // clock string (e.g., '08:26:01.77') to Date using event date local time
  function toClock(dateStr, clockStr){
    if(!clockStr) return null;
    let str = `${dateStr}T${clockStr}`;
    if(clockStr.indexOf('.')<0) str += '.00';
    // treat as local time (KST) — browser will parse as local
    return new Date(str);
  }

  async function fetchPlayer(eventId, bib){
    const url = `https://myresult.co.kr/api/event/${encodeURIComponent(eventId)}/player/${encodeURIComponent(bib)}`;
    const r = await fetch(url, {headers:{'Accept':'application/json','Cache-Control':'no-cache'}});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();
    // redaction: drop mobile
    delete j.mobile;
    return j;
  }

  function estimateNow(j, now=new Date()){
    const courseDist = parseFloat(j.course?.distance || j.course_distance || '0');
    const recs = (j.records||[]).slice().sort((a,b)=>parseFloat(a.point.distance)-parseFloat(b.point.distance));
    if(recs.length===0){
      return { status:'not_started', D_now:0, lastPoint:null, lastTime:null, progress:0 };
    }
    const date = j.event?.date || '';
    const Ds = recs.map(r=>parseFloat(r.point.distance));
    const Ts = recs.map(r=>toClock(date, r.time_point));
    const k = recs.length-1;
    const Dk = Ds[k];
    const Tk = Ts[k];

    // speed km/s from last segment; fallback to avg pace
    let vk = null;
    if(k>=1){
      const d = Ds[k]-Ds[k-1];
      const t = (Ts[k]-Ts[k-1])/1000; // sec
      if(d>0 && t>0) vk = d/t;
    }
    if(!vk && j.pace_nettime){
      const [m,s] = j.pace_nettime.split(':').map(Number);
      const secPerKm = m*60 + s;
      if(secPerKm>0) vk = 1/secPerKm;
    }
    if(!vk) vk = 1/360; // 6:00/km fallback

    // next point distance (or finish)
    const next = (j.course?.points||[]).filter(p=>parseFloat(p.distance)>Dk).sort((a,b)=>parseFloat(a.distance)-parseFloat(b.distance))[0];
    const Dnext = next ? parseFloat(next.distance) : courseDist;

    const dt = Math.max(0, (now - Tk)/1000);
    let Dhat = Dk + vk*dt;
    if(Dhat > Dnext) Dhat = Dnext;

    const progress = courseDist>0 ? Math.min(100, Math.max(0, Dhat/courseDist*100)) : 0;
    const status = (Dhat>=courseDist || j.result_nettime) ? 'finished' : (Dk>0 ? 'running' : 'not_started');

    return { status, D_now:Dhat, D_last:Dk, lastPoint:recs[k].point?.name||'', lastTime:Tk, progress };
  }

  function renderRow(j, est){
    const bib = j.num || j.tag || '';
    const name = j.name || '';
    const net = j.result_nettime || '';
    const pace = j.pace_nettime || '';
    const tr = document.createElement('tr');

    const statusPill = est.status==='finished' ? '<span class="pill fin">완주</span>'
      : est.status==='running' ? '<span class="pill run">주행</span>'
      : '<span class="pill">대기</span>';

    tr.innerHTML = `
      <td>${name}</td>
      <td class="mono">${bib}</td>
      <td>${statusPill}</td>
      <td class="mono">${est.D_now?.toFixed(2) ?? ''}</td>
      <td>${est.lastPoint||''}</td>
      <td class="mono">${fmtTime(est.lastTime?.toISOString?.()) || ''}</td>
      <td class="mono">${net}</td>
      <td class="mono">${pace}</td>
      <td>
        <div class="progress"><div class="bar" style="width:${est.progress.toFixed(1)}%"></div></div>
        <div class="tiny muted">${est.progress.toFixed(1)}%</div>
      </td>
      <td class="right tiny muted"></td>
    `;
    return tr;
  }

  function renderErrorRow(bib, err){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td colspan="9"><span class="err">${bib}</span></td>
      <td class="right tiny err">${String(err).replace(/[\r\n]+/g,' ')}</td>
    `;
    return tr;
  }

  async function tick(){
    const eventId = $('#eventId').value.trim();
    const bibs = parseBibs($('#bibs').value);
    const tbody = $('#tbl tbody');
    tbody.innerHTML = '';

    // throttle: stagger requests to avoid spike
    const results = [];
    for (let i=0;i<bibs.length;i++){
      const bib = bibs[i];
      try{
        // stagger 150ms between calls
        /* eslint-disable no-await-in-loop */
        if(i>0) await new Promise(r=>setTimeout(r,150));
        const j = await fetchPlayer(eventId, bib);
        state.cache.set(bib, j);
        const est = estimateNow(j, new Date());
        results.push({j, est});
      }catch(e){
        results.push({error:e, bib});
      }
    }

    // sort: running first, then finished, then not started; within, by progress desc
    results.sort((a,b)=>{
      const sa = a.est ? (a.est.status==='running'?0:(a.est.status==='finished'?1:2)) : 3;
      const sb = b.est ? (b.est.status==='running'?0:(b.est.status==='finished'?1:2)) : 3;
      if(sa!==sb) return sa-sb;
      const pa = a.est?.progress||0; const pb = b.est?.progress||0;
      return pb - pa;
    });

    for (const r of results){
      if(r.error){ tbody.appendChild(renderErrorRow(r.bib, r.error)); continue; }
      tbody.appendChild(renderRow(r.j, r.est));
    }
  }

  function start(){
    $('#startBtn').disabled = true;
    $('#stopBtn').disabled = false;
    tick();
    const sec = Math.max(5, Number($('#intervalSec').value)||10);
    state.timer = setInterval(tick, sec*1000);
  }
  function stop(){
    $('#startBtn').disabled = false;
    $('#stopBtn').disabled = true;
    if(state.timer){ clearInterval(state.timer); state.timer = null; }
  }

  $('#startBtn').addEventListener('click', start);
  $('#stopBtn').addEventListener('click', stop);

  // demo fill (지우고 사용 가능)
  $('#bibs').value = [
    '3725','3729','3730','3744','3801'
  ].join('\n');
  </script>
</body>
</html>
