<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunCheer — 우리 주자를 응원해요! 🏃‍♂️💨</title>
  <style>
    :root{--bg:#0b0d12;--card:#131826;--muted:#9fb0c7;--fg:#e8eef9;--acc:#5cc8ff;--ok:#7CFC00;--err:#ff6b6b}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif;scroll-behavior:auto}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    h1{margin:0 0 6px;font-size:20px}
    .muted{color:var(--muted)}
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,.28);padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 240px}
    input,textarea,button{width:100%;box-sizing:border-box;background:#0e111a;border:1px solid #2a3142;color:var(--fg);border-radius:10px;padding:10px}
    button{cursor:pointer;background:linear-gradient(180deg,#1a9fff,#0066cc);border:none}
    button.secondary{background:#0e111a;border:1px solid #2a3142}
    button.ghost{background:transparent;border:1px dashed #2a3142}
    button:disabled{opacity:.5;cursor:not-allowed}
    #eventsList{max-height:320px;overflow:auto;border:1px solid #2a3142;border-radius:10px;padding:8px;background:#0e111a}
    .evbtn{display:flex;align-items:center;justify-content:space-between;gap:10px;width:100%;border-radius:10px;padding:10px 12px;background:#0e111a;border:1px solid #293143;margin:6px 0}
    .evbtn .name{font-weight:700}
    .evbtn .date{font-size:12px;color:var(--muted)}
    .active{outline:2px solid var(--acc)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:10px 12px;vertical-align:top}
    tbody tr{background:#0e111a}
    tbody tr.player-main td:first-child{border-radius:10px 0 0 0}
    tbody tr.player-main td:last-child{border-radius:0 10px 0 0}
    tbody tr.player-splits td{border-top:1px solid #1a1f2e;border-radius:0 0 10px 10px;padding-top:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .tiny{font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .pill.run{background:rgba(92,200,255,.12);color:var(--acc)}
    .pill.fin{background:rgba(159,176,199,.12);color:#d7e1f3}
    .pill.wait{background:rgba(159,176,199,.08);color:#b6c3d7}
    .err{color:var(--err)}
    .splits{display:flex;flex-direction:column;gap:3px;font-size:12px;color:var(--muted);padding:5px 0}
    .splits.collapsed{max-height:60px;overflow:hidden;position:relative}
    .splits.collapsed::after{content:'';position:absolute;bottom:0;left:0;right:0;height:30px;background:linear-gradient(transparent,#0e111a)}
    .toggle-splits{cursor:pointer;color:var(--acc);font-size:11px;margin-top:5px;user-select:none}
    .toggle-splits:hover{text-decoration:underline}
    #map{width:100%;height:500px;border-radius:10px;background:#0e111a}
    .player-label{
      background:rgba(92,200,255,0.95);
      color:#fff;
      padding:6px 12px;
      border-radius:20px;
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
      border:2px solid #fff;
      cursor:pointer;
      transition:all 0.2s;
    }
    .player-label:hover{
      background:rgba(26,159,255,1);
      transform:scale(1.05);
    }
  </style>
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=04ebpnqto6"></script>
</head>
<body>
  <div class="wrap">
    <h1>RunCheer — 우리 주자를 응원해요! 🏃‍♂️💨</h1>

    <!-- 이벤트 리스트 -->
    <div class="card">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <div style="font-weight:700">모든 이벤트</div>
        <button id="reloadEv" class="secondary" style="flex:0 0 auto;width:auto">다시 불러오기</button>
      </div>
      <div id="eventsList"></div>
    </div>

    <!-- 배번 입력 & 제어 -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label class="tiny muted">선택된 이벤트</label>
          <div id="picked" class="mono">(없음)</div>
        </div>
        <div class="col">
          <label class="tiny muted">조회 주기(초)</label>
          <input id="intervalSec" type="number" min="5" value="10" />
        </div>
        <div class="col" style="flex:0 0 220px;align-self:end;display:flex;gap:8px">
          <button id="startBtn">시작</button>
          <button id="stopBtn" class="secondary" disabled>정지</button>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label class="tiny muted">배번 목록(쉼표/줄바꿈)</label>
          <textarea id="bibs" rows="4"></textarea>
        </div>
        <div class="col" style="flex:0 0 220px;align-self:end">
          <button id="saveBibs" class="ghost">배번 저장</button>
        </div>
      </div>
    </div>

    <!-- 지도 -->
    <div class="card">
      <div style="font-weight:700;margin-bottom:10px">📍 주자 위치</div>
      <div id="map"></div>
    </div>

    <!-- 결과 테이블 -->
    <div class="card">
      <div id="status" class="tiny muted">이벤트를 선택하고 시작을 누르세요.</div>
      <table>
        <thead>
          <tr><th>이름</th><th>배번</th><th>상태</th><th>누적(km)</th><th>마지막 통과</th><th>넷기록</th><th>페이스</th><th>오류</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
function API(path){return `/api/proxy?path=${encodeURIComponent(path)}`;}
const $=s=>document.querySelector(s),$$=s=>Array.from(document.querySelectorAll(s));
function parseBibs(t){return t.split(/[\n,\s]+/).map(s=>s.trim()).filter(Boolean)}
function fmtClockISO(i){return i?i.replace('T',' ').replace('Z',''):''}
const S={eventId:null,timer:null,rows:new Map(),map:null,markers:new Map(),eventData:null,coursePath:null,gpxPoints:[],checkpointMarkers:[]};

function calcDistance(lat1,lng1,lat2,lng2){const R=6371;const dLat=(lat2-lat1)*Math.PI/180;const dLng=(lng2-lng1)*Math.PI/180;const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c;}

function getPositionOnRoute(distanceKm){if(!S.gpxPoints||S.gpxPoints.length===0)return null;let accumulated=0;for(let i=1;i<S.gpxPoints.length;i++){const prev=S.gpxPoints[i-1];const curr=S.gpxPoints[i];const segDist=calcDistance(prev.lat(),prev.lng(),curr.lat(),curr.lng());if(accumulated+segDist>=distanceKm){const ratio=(distanceKm-accumulated)/segDist;const lat=prev.lat()+(curr.lat()-prev.lat())*ratio;const lng=prev.lng()+(curr.lng()-prev.lng())*ratio;return new naver.maps.LatLng(lat,lng);}accumulated+=segDist;}return S.gpxPoints[S.gpxPoints.length-1];}

async function loadGPXCourse(){
  try{
    const r=await fetch('/course.gpx');
    const text=await r.text();
    const parser=new DOMParser();
    const xml=parser.parseFromString(text,'text/xml');
    const trkpts=xml.querySelectorAll('trkpt');
    const path=[];
    trkpts.forEach(pt=>{
      const lat=parseFloat(pt.getAttribute('lat'));
      const lon=parseFloat(pt.getAttribute('lon'));
      if(lat&&lon)path.push(new naver.maps.LatLng(lat,lon));
    });
    S.gpxPoints=path;
    console.log(`GPX loaded: ${path.length} points`);
    return path;
  }catch(e){
    console.error('Failed to load GPX:',e);
    return null;
  }
}

async function drawCoursePath(){
  if(!S.map)return;
  const path=await loadGPXCourse();
  if(!path||path.length===0)return;
  if(S.coursePath){S.coursePath.setMap(null);}
  S.coursePath=new naver.maps.Polyline({
    path:path,
    strokeColor:'#FF0000',
    strokeOpacity:0.6,
    strokeWeight:4,
    map:S.map
  });
  const bounds=new naver.maps.LatLngBounds();
  path.forEach(p=>bounds.extend(p));
  S.map.fitBounds(bounds);
  
  // 기존 체크포인트 마커 제거
  S.checkpointMarkers.forEach(m=>m.setMap(null));
  S.checkpointMarkers=[];
  
  // 체크포인트 마커 추가 (춘천마라톤만)
  const checkpoints=[
    {name:'출발',distance:0.00},
    {name:'반환점',distance:4.00},
    {name:'5K',distance:5.00},
    {name:'10K',distance:10.00},
    {name:'15K',distance:15.00},
    {name:'20K',distance:20.00},
    {name:'Half',distance:21.10},
    {name:'25K',distance:25.00},
    {name:'30K',distance:30.00},
    {name:'35K',distance:35.00},
    {name:'40K',distance:40.00},
    {name:'도착',distance:42.20}
  ];
  checkpoints.forEach(cp=>{
    const pos=getPositionOnRoute(cp.distance);
    if(pos){
      const marker=new naver.maps.Marker({
        position:pos,
        map:S.map,
        icon:{
          content:`<div style="background:#2a3f5f;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:bold;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);">${cp.name}</div>`,
          anchor:new naver.maps.Point(0,25)
        }
      });
      S.checkpointMarkers.push(marker);
    }
  });
  console.log('Course path drawn');
}

async function loadEvents(){
 const el=$('#eventsList');el.innerHTML='<div>불러오는 중...</div>';
 try{
   const r=await fetch(API('event'));
   const j=await r.json();
   let list=(j.results||[]);
   // 수동 추가 이벤트(유지)
   const manual=[
    {id:92,name:'2024 JTBC 서울마라톤',date:'2024-11-03'},
    {id:91,name:'춘천마라톤 2024',date:'2024-10-27'},
    {id:85,name:'70K KALEG BRIDGE RELAY RACE',date:'2024-10-06'},
    {id:79,name:'춘천 스카이레이스 2024',date:'2024-09-22'},
    {id:51,name:'2023 JTBC 서울마라톤',date:'2023-11-05'},
    {id:49,name:'춘천마라톤 2023',date:'2023-10-29'},
    {id:19,name:'2022 LIFEPLUS JTBC 서울 마라톤',date:'2022-11-06'},
    {id:16,name:'춘천마라톤 2022',date:'2022-10-23'}
   ];
   list=list.concat(manual).sort((a,b)=>(b.date||'').localeCompare(a.date||''));
   el.innerHTML='';
   list.forEach(ev=>{
     const b=document.createElement('button');
     b.className='evbtn';
     b.innerHTML=`<div class="name">(#${ev.id}) ${ev.name}</div><div class="date">${ev.date||''}</div>`;
     b.onclick=()=>pickEvent(ev,b);
     el.appendChild(b);
   });
 }catch(e){
   el.innerHTML='<div class="err">로드 실패</div>'
 }
}

function pickEvent(ev,b){S.eventId=ev.id;$('#picked').textContent=`${ev.name} (#${ev.id})`;$$('.evbtn').forEach(x=>x.classList.remove('active'));b.classList.add('active');const saved=localStorage.getItem(`bibs:${S.eventId}`);if(saved)$('#bibs').value=JSON.parse(saved).join('\n');if(S.map){if(ev.id===132||ev.id===91){drawCoursePath();}else{if(S.coursePath){S.coursePath.setMap(null);S.coursePath=null;}S.checkpointMarkers.forEach(m=>m.setMap(null));S.checkpointMarkers=[];}}}
$('#reloadEv').onclick=loadEvents;
$('#saveBibs').onclick=()=>{if(!S.eventId)return alert('이벤트 선택');localStorage.setItem(`bibs:${S.eventId}`,JSON.stringify(parseBibs($('#bibs').value)))};
async function fetchPlayer(eid,bib){const r=await fetch(API(`event/${eid}/player/${bib}`));if(!r.ok)throw new Error('HTTP '+r.status);return await r.json()}
function estimateNow(j){const dist=parseFloat(j.course?.distance||'0');const recs=(j.records||[]).sort((a,b)=>a.point.distance-b.point.distance);if(!recs.length)return{status:'대기',d:0,name:'',iso:'',estimated:0};const lastRec=recs.at(-1);const d=parseFloat(lastRec.point.distance);const name=lastRec.point.name;const time=lastRec.time_point;const date=j.event?.date;const lastTime=new Date(`${date}T${time}`);const now=new Date();const elapsedSec=(now-lastTime)/1000;let estimatedDist=d;if(j.pace_nettime&&elapsedSec>0&&!j.result_nettime){const paceStr=j.pace_nettime.split('.')[0];const paceSec=timeToSeconds(paceStr);if(paceSec>0){const kmPerSec=1/paceSec;const movedKm=kmPerSec*elapsedSec;estimatedDist=Math.min(d+movedKm,dist);}}return{status:j.result_nettime?'완주':'주행',d,name,iso:lastTime.toISOString(),estimated:estimatedDist}}
function cleanTime(t){if(!t)return'';return t.split('.')[0]}
function timeToSeconds(t){if(!t)return 0;const clean=t.split('.')[0];const p=clean.split(':').map(Number);if(p.length===3)return p[0]*3600+p[1]*60+p[2];if(p.length===2)return p[0]*60+p[1];return 0}
function calcPace(distKm,sec){if(!distKm||distKm<=0)return'';const minPerKm=sec/60/distKm;const m=Math.floor(minPerKm);const s=Math.round((minPerKm-m)*60);return`${m}'${s.toString().padStart(2,'0')}"`}
function renderSplits(j){const recs=(j.records||[]).sort((a,b)=>a.point.distance-b.point.distance);const bib=j.num||j.tag;const splitsId=`splits-${bib}`;const toggleId=`toggle-${bib}`;return`<div class='splits collapsed' id='${splitsId}'>${recs.map((r,i)=>{let pace='';if(i>0){const prevDist=recs[i-1].point.distance;const dist=r.point.distance-prevDist;const prevSec=timeToSeconds(recs[i-1].time_point);const sec=timeToSeconds(r.time_point)-prevSec;pace=` (${calcPace(dist,sec)})`}return`<div>${r.point.name||''} ${r.point.distance}km ${cleanTime(r.time_point)}${pace}</div>`}).join('')}</div><div class='toggle-splits' id='${toggleId}' onclick="toggleSplits('${splitsId}','${toggleId}')">▼ 더보기</div>`}
function ensureRow(bib){if(S.rows.has(bib))return S.rows.get(bib);const trMain=document.createElement('tr');trMain.className='player-main';trMain.innerHTML='<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>';const trSplits=document.createElement('tr');trSplits.className='player-splits';trSplits.innerHTML='<td colspan="8" style="padding:8px 12px"></td>';$('#tbody').appendChild(trMain);$('#tbody').appendChild(trSplits);const c=trMain.querySelectorAll('td');const splitsCell=trSplits.querySelector('td');S.rows.set(bib,{trMain,trSplits,c,splitsCell});return S.rows.get(bib)}
function updateRow(j){const bib=j.num||j.tag;const r=ensureRow(bib);const est=estimateNow(j);r.c[0].textContent=j.name;r.c[1].textContent=bib;r.c[2].textContent=est.status;r.c[3].textContent=est.d;r.c[4].textContent=est.name;r.c[5].textContent=cleanTime(j.result_nettime);r.c[6].textContent=cleanTime(j.pace_nettime);r.c[7].textContent='';r.splitsCell.innerHTML=renderSplits(j);updateMarker(j,bib);}
function updateError(bib,e){const r=ensureRow(bib);r.c[7].textContent=e;}
function toggleSplits(splitsId,toggleId){const splits=document.getElementById(splitsId);const toggle=document.getElementById(toggleId);if(!splits||!toggle)return;if(splits.classList.contains('collapsed')){splits.classList.remove('collapsed');toggle.textContent='▲ 접기';}else{splits.classList.add('collapsed');toggle.textContent='▼ 더보기';}}
function initMap(){if(!window.naver||!window.naver.maps){console.error('Naver Maps API not loaded');return}const center=new naver.maps.LatLng(37.5665,126.9780);S.map=new naver.maps.Map('map',{center:center,zoom:13,mapTypeControl:true});console.log('Map initialized');}
function updateMarker(playerData,bib){if(!S.map)return;const est=estimateNow(playerData);const distKm=parseFloat(est.estimated);if(!distKm||distKm===0){console.log(`No distance for player ${bib}`);return;}const pos=getPositionOnRoute(distKm);if(!pos){console.log(`Cannot calculate position for player ${bib} at ${distKm}km`);return;}if(S.markers.has(bib)){const item=S.markers.get(bib);item.marker.setPosition(pos);item.label.setPosition(pos);const newContent=`<div class="player-label" style="background:rgba(66,133,244,0.95);">${playerData.name}</div>`;item.label.setIcon({content:newContent,anchor:new naver.maps.Point(0,30)});}else{const marker=new naver.maps.Marker({position:pos,map:S.map,icon:{content:`<div style="width:12px;height:12px;background:#5cc8ff;border:3px solid #fff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>`,anchor:new naver.maps.Point(9,9)}});const labelContent=`<div class="player-label" style="background:rgba(66,133,244,0.95);">${playerData.name}</div>`;const label=new naver.maps.Marker({position:pos,map:S.map,icon:{content:labelContent,anchor:new naver.maps.Point(0,30)}});const infoContent=`<div style="padding:10px;background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.3);min-width:150px"><div style="font-weight:700;margin-bottom:5px;color:#333">${playerData.name}</div><div style="font-size:12px;color:#666">배번: ${bib}</div><div style="font-size:12px;color:#666">마지막 통과: ${est.name}</div><div style="font-size:12px;color:#666">통과 거리: ${est.d}km</div><div style="font-size:12px;color:#4285f4;font-weight:bold">📍 예상 위치: ${est.estimated.toFixed(2)}km${est.estimated>est.d?` (+${(est.estimated-est.d).toFixed(2)}km)`:''}</div><div style="font-size:12px;color:#666">넷기록: ${playerData.result_nettime||'-'}</div><div style="font-size:12px;color:#666">페이스: ${playerData.pace_nettime||'-'}</div></div>`;const infoWindow=new naver.maps.InfoWindow({content:infoContent});naver.maps.Event.addListener(marker,'click',()=>{if(infoWindow.getMap()){infoWindow.close()}else{infoWindow.open(S.map,marker)}});naver.maps.Event.addListener(label,'click',()=>{if(infoWindow.getMap()){infoWindow.close()}else{infoWindow.open(S.map,marker)}});S.markers.set(bib,{marker:marker,label:label,infoWindow:infoWindow});if(S.markers.size===1){S.map.setCenter(pos);S.map.setZoom(14);}};}
async function loadEventData(){if(!S.eventId)return;try{const r=await fetch(API(`event/${S.eventId}`));const data=await r.json();S.eventData=data;console.log('Event data loaded:',data);}catch(e){console.error('Failed to load event data:',e);}}
async function tick(){if(!S.eventId)return;const bibs=parseBibs($('#bibs').value);const seen=new Set(bibs);for(const b of bibs){try{const j=await fetchPlayer(S.eventId,b);updateRow(j);}catch(e){updateError(b,e)}}for(const [b,{trMain,trSplits}]of S.rows){if(!seen.has(b)){trMain.remove();trSplits.remove();S.rows.delete(b);const item=S.markers.get(b);if(item){item.marker.setMap(null);item.label.setMap(null);S.markers.delete(b)}}}}
$('#startBtn').onclick=async()=>{if(!S.eventId)return alert('이벤트 선택');$('#startBtn').disabled=true;$('#stopBtn').disabled=false;await loadEventData();tick();S.timer=setInterval(tick,Math.max(5,Number($('#intervalSec').value))*1000)};
$('#stopBtn').onclick=()=>{clearInterval(S.timer);S.timer=null;$('#startBtn').disabled=false;$('#stopBtn').disabled=true};
loadEvents();
setTimeout(initMap,500);
</script>
</script>
</body>
</html>
